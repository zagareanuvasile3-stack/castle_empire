<script>
    const tg = window.Telegram.WebApp;
    let userData = null;

    function initGame() {
        tg.expand();
        tg.MainButton.setText("–ó–ê–ö–†–´–¢–¨");
        tg.MainButton.show();
        tg.MainButton.onClick(() => tg.close());
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        setTimeout(loadUserData, 1000);
        setInterval(updateTimer, 1000);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        console.log("üü¢ WebApp –∑–∞–ø—É—â–µ–Ω!");
        console.log("User ID:", tg.initDataUnsafe.user?.id);
    }

    function loadUserData() {
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            const requestData = {
                action: 'get_user_data',
                user_id: tg.initDataUnsafe.user?.id
            };
            
            console.log("üì® –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö:", requestData);
            tg.sendData(JSON.stringify(requestData));
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
            setTestData();
        }
    }

    function setTestData() {
        userData = {
            gems: 5.0,
            food: 120,
            wood: 80,
            stone: 60,
            last_collection: Date.now() - 10 * 60 * 60 * 1000, // 10 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
            castle_level: 1,
            farm_level: 1,
            sawmill_level: 1,
            mine_level: 1,
            referrals_count: 0
        };
        updateResourcesDisplay();
        updateTimer();
    }

    function updateTimer() {
        if (!userData || !userData.last_collection) return;
        
        const now = Date.now();
        const timePassed = now - userData.last_collection;
        const timeLeft = 12 * 60 * 60 * 1000 - timePassed;
        
        const timerElement = document.getElementById('timer');
        const timerStatus = document.getElementById('timerStatus');
        const collectBtn = document.getElementById('collectBtn');
        
        if (timeLeft <= 0) {
            timerElement.textContent = "00:00:00";
            timerStatus.innerHTML = "‚úÖ –†–µ—Å—É—Ä—Å—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–±–æ—Ä—É!";
            timerStatus.className = "timer-status ready";
            collectBtn.disabled = false;
        } else {
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (60000)) / 1000);
            
            timerElement.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timerStatus.innerHTML = `‚è≥ –î–æ —Å–±–æ—Ä–∞: <span id="timer">${timerElement.textContent}</span>`;
            timerStatus.className = "timer-status";
            collectBtn.disabled = true;
        }
    }

    function collectResources() {
        try {
            const collectData = {
                action: 'collect_resources',
                user_id: tg.initDataUnsafe.user?.id,
                timestamp: Date.now()
            };
            
            console.log("üéÅ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–±–æ—Ä:", collectData);
            tg.sendData(JSON.stringify(collectData));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            tg.showPopup({
                title: "‚úÖ –°–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤",
                message: "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
                buttons: [{ type: "ok" }]
            });
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:", error);
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Ä–µ—Å—É—Ä—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }
    }

    function showReferralPopup() {
        const referralLink = `https://t.me/${tg.initDataUnsafe.user?.username || 'CastleEmpireBot'}?start=ref_${tg.initDataUnsafe.user?.id}`;
        
        tg.showPopup({
            title: "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π",
            message: `–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n${referralLink}\n\n–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1% –æ—Ç –µ–≥–æ –¥–æ–±—ã—á–∏!`,
            buttons: [{
                type: 'default',
                text: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',
                id: 'copy'
            }, {
                type: 'cancel'
            }]
        }, function(buttonId) {
            if (buttonId === 'copy') {
                navigator.clipboard.writeText(referralLink).then(() => {
                    tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
                });
            }
        });
    }

    function showUpgradeMenu() {
        document.getElementById('upgradeMenu').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        
        if (!userData) return;
        
        const upgradeOptions = document.getElementById('upgrade-options');
        upgradeOptions.innerHTML = `
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div><strong>üè∞ –ó–∞–º–æ–∫</strong></div>
                <div>–£—Ä–æ–≤–µ–Ω—å ${userData.castle_level || 1}</div>
                <button onclick="upgradeBuilding('castle')" style="margin-top: 5px; padding: 5px 10px;">–£–ª—É—á—à–∏—Ç—å (100 üíé)</button>
            </div>
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div><strong>üåæ –§–µ—Ä–º–∞</strong></div>
                <div>–£—Ä–æ–≤–µ–Ω—å ${userData.farm_level || 1}</div>
                <button onclick="upgradeBuilding('farm')" style="margin-top: 5px; padding: 5px 10px;">–£–ª—É—á—à–∏—Ç—å (80 üíé)</button>
            </div>
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div><strong>ü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞</strong></div>
                <div>–£—Ä–æ–≤–µ–Ω—å ${userData.sawmill_level || 1}</div>
                <button onclick="upgradeBuilding('sawmill')" style="margin-top: 5px; padding: 5px 10px;">–£–ª—É—á—à–∏—Ç—å (90 üíé)</button>
            </div>
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div><strong>‚õèÔ∏è –®–∞—Ö—Ç–∞</strong></div>
                <div>–£—Ä–æ–≤–µ–Ω—å ${userData.mine_level || 1}</div>
                <button onclick="upgradeBuilding('mine')" style="margin-top: 5px; padding: 5px 10px;">–£–ª—É—á—à–∏—Ç—å (70 üíé)</button>
            </div>
        `;
    }

    function upgradeBuilding(buildingType) {
        const upgradeData = {
            action: 'upgrade_building',
            building: buildingType,
            user_id: tg.initDataUnsafe.user?.id
        };
        
        console.log("‚ö° –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ:", upgradeData);
        tg.sendData(JSON.stringify(upgradeData));
        
        tg.showAlert(`–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ ${buildingType} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
        hideMenus();
    }

    function hideMenus() {
        document.getElementById('upgradeMenu').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function showStats() {
        if (!userData) return;
        
        tg.showPopup({
            title: "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞",
            message: `üíé –ê–ª–º–∞–∑—ã: ${userData.gems}\nüåæ –ï–¥–∞: ${userData.food}\nü™µ –î–µ—Ä–µ–≤–æ: ${userData.wood}\n‚õ∞Ô∏è –ö–∞–º–µ–Ω—å: ${userData.stone}\n\nüè∞ –ó–∞–º–æ–∫: –£—Ä. ${userData.castle_level}\nüåæ –§–µ—Ä–º–∞: –£—Ä. ${userData.farm_level}\nü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞: –£—Ä. ${userData.sawmill_level}\n‚õèÔ∏è –®–∞—Ö—Ç–∞: –£—Ä. ${userData.mine_level}`,
            buttons: [{ type: "ok" }]
        });
    }

    function updateResourcesDisplay() {
        if (!userData) return;
        
        document.getElementById('gems-count').textContent = userData.gems.toFixed(1);
        document.getElementById('food-count').textContent = userData.food;
        document.getElementById('wood-count').textContent = userData.wood;
        document.getElementById('stone-count').textContent = userData.stone;
        document.getElementById('referrals-count').textContent = userData.referrals_count || 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–Ω–∏ –∑–¥–∞–Ω–∏–π
        const castleElement = document.querySelector('[data-type="castle"] .building-level');
        const farmElement = document.querySelector('[data-type="farm"] .building-level');
        const sawmillElement = document.querySelector('[data-type="sawmill"] .building-level');
        const mineElement = document.querySelector('[data-type="mine"] .building-level');
        
        if (castleElement) castleElement.textContent = `–£—Ä–æ–≤–µ–Ω—å ${userData.castle_level || 1}`;
        if (farmElement) farmElement.textContent = `–£—Ä–æ–≤–µ–Ω—å ${userData.farm_level || 1}`;
        if (sawmillElement) sawmillElement.textContent = `–£—Ä–æ–≤–µ–Ω—å ${userData.sawmill_level || 1}`;
        if (mineElement) mineElement.textContent = `–£—Ä–æ–≤–µ–Ω—å ${userData.mine_level || 1}`;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
    if (!window.Telegram) {
        console.warn("‚ö†Ô∏è –ó–∞–ø—É—Å–∫ –≤–Ω–µ Telegram - —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
        window.Telegram = {
            WebApp: {
                expand: () => console.log("üì± Expand"),
                MainButton: {
                    setText: (text) => console.log("üìù Set text:", text),
                    show: () => console.log("üëÄ Show button"),
                    onClick: (cb) => console.log("üñ±Ô∏è Button click handler"),
                    hide: () => console.log("üôà Hide button")
                },
                sendData: (data) => {
                    console.log("üì® Send data:", data);
                    // –≠–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
                    setTimeout(() => {
                        if (typeof window.onTelegramData === 'function') {
                            window.onTelegramData(JSON.parse(data));
                        }
                    }, 1000);
                },
                showPopup: (options) => console.log("üìã Popup:", options),
                showAlert: (message) => console.log("‚ö†Ô∏è Alert:", message),
                initDataUnsafe: { user: { id: 12345, username: 'test_user' } }
            }
        };
    }

    document.addEventListener('DOMContentLoaded', initGame);
                </script>
