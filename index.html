<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #0b2b40 0%, #093145 100%);
            color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            padding: 15px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(25, 55, 75, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(42, 150, 165, 0.3);
        }
        
        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: #ff9d00;
            margin-bottom: 5px;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .resource-card {
            background: linear-gradient(135deg, #15616b 0%, #093145 100%);
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .resource-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9d00 0%, #ff7800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .resource-info {
            flex: 1;
        }
        
        .resource-name {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .resource-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .building-card {
            background: linear-gradient(135deg, #1e5f75 0%, #164b60 100%);
            border-radius: 14px;
            padding: 18px 12px;
            text-align: center;
            border: 2px solid rgba(42, 150, 165, 0.3);
        }
        
        .building-icon {
            font-size: 36px;
            margin-bottom: 8px;
            display: block;
        }
        
        .building-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 5px;
        }
        
        .building-level {
            background: rgba(0,0,0,0.3);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .building-production {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .timer-status {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .timer-status.ready {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }
        
        .collection-info {
            font-size: 12px;
            opacity: 0.8;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .actions-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #ff9d00 0%, #ff7800 100%);
            color: #093145;
            border: none;
            padding: 14px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            box-shadow: 0 3px 8px rgba(255, 157, 0, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .action-btn:active:not(:disabled) {
            transform: scale(0.97);
        }
        
        .btn-icon {
            font-size: 20px;
        }
        
        .status-bar {
            background: rgba(25, 55, 75, 0.7);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .upgrade-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e5f75 0%, #164b60 100%);
            padding: 20px;
            border-radius: 16px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }

        .upgrade-option {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">üè∞ Castle Empire</div>
            <div>–†–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ!</div>
        </div>
        
        <div class="resources-grid">
            <div class="resource-card">
                <div class="resource-icon">üíé</div>
                <div class="resource-info">
                    <div class="resource-name">–ê–õ–ú–ê–ó–´</div>
                    <div class="resource-amount" id="gems-count">0</div>
                </div>
            </div>
            
            <div class="resource-card">
                <div class="resource-icon">üåæ</div>
                <div class="resource-info">
                    <div class="resource-name">–ï–î–ê</div>
                    <div class="resource-amount" id="food-count">0</div>
                </div>
            </div>
            
            <div class="resource-card">
                <div class="resource-icon">ü™µ</div>
                <div class="resource-info">
                    <div class="resource-name">–î–ï–†–ï–í–û</div>
                    <div class="resource-amount" id="wood-count">0</div>
                </div>
            </div>
            
            <div class="resource-card">
                <div class="resource-icon">‚õ∞Ô∏è</div>
                <div class="resource-info">
                    <div class="resource-name">–ö–ê–ú–ï–ù–¨</div>
                    <div class="resource-amount" id="stone-count">0</div>
                </div>
            </div>
        </div>
        
        <div class="buildings-grid">
            <div class="building-card" data-type="castle">
                <span class="building-icon">üè∞</span>
                <div class="building-name">–ó–ê–ú–û–ö</div>
                <div class="building-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
                <div class="building-production">+0.1 –∞–ª–º–∞–∑–æ–≤/—á–∞—Å</div>
            </div>
            
            <div class="building-card" data-type="farm">
                <span class="building-icon">üåæ</span>
                <div class="building-name">–§–ï–†–ú–ê</div>
                <div class="building-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
                <div class="building-production">+5 –µ–¥—ã/—á–∞—Å</div>
            </div>
            
            <div class="building-card" data-type="sawmill">
                <span class="building-icon">ü™µ</span>
                <div class="building-name">–õ–ï–°–û–ü–ò–õ–ö–ê</div>
                <div class="building-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
                <div class="building-production">+3 –¥–µ—Ä–µ–≤–∞/—á–∞—Å</div>
            </div>
            
            <div class="building-card" data-type="mine">
                <span class="building-icon">‚õèÔ∏è</span>
                <div class="building-name">–®–ê–•–¢–ê</div>
                <div class="building-level">–£—Ä–æ–≤–µ–Ω—å 1</div>
                <div class="building-production">+2 –∫–∞–º–Ω—è/—á–∞—Å</div>
            </div>
        </div>
        
        <div class="timer-status" id="timerStatus">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div class="collection-info">
            üí° –ú–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
        </div>
        
        <div class="actions-bar">
            <button class="action-btn" id="collectBtn" onclick="collectResources()">
                <span class="btn-icon">üéÅ</span>
                <span>–°–û–ë–†–ê–¢–¨</span>
            </button>
            
            <button class="action-btn" onclick="showReferralPopup()">
                <span class="btn-icon">üë•</span>
                <span>–ü–†–ò–ì–õ–ê–°–ò–¢–¨</span>
            </button>
            
            <button class="action-btn" onclick="showUpgradeMenu()">
                <span class="btn-icon">‚ö°</span>
                <span>–£–õ–£–ß–®–ò–¢–¨</span>
            </button>
            
            <button class="action-btn" onclick="showStats()">
                <span class="btn-icon">üìä</span>
                <span>–°–¢–ê–¢–ò–°–¢–ò–ö–ê</span>
            </button>
        </div>
        
        <div class="status-bar">
            üëë –ò–≥—Ä–æ–∫: <span id="player-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span> | üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: <span id="referrals-count">0</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hideMenus()"></div>
    
    <div class="upgrade-menu" id="upgradeMenu">
        <h3>‚ö° –£–ª—É—á—à–µ–Ω–∏–µ –∑–¥–∞–Ω–∏–π</h3>
        <div id="upgrade-options"></div>
        <button onclick="hideMenus()" style="margin-top: 15px; padding: 10px; width: 100%; background: #ff9d00; color: #093145; border: none; border-radius: 8px; font-weight: bold;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let userData = null;

        function initGame() {
            console.log("üü¢ WebApp Castle Empire –∑–∞–ø—É—â–µ–Ω!");
            
            // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            tg.MainButton.setText("–ó–ê–ö–†–´–¢–¨ –ò–ì–†–£");
            tg.MainButton.show();
            tg.MainButton.onClick(() => tg.close());
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
            showLoadingData();
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            setTimeout(loadUserData, 1500);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            setInterval(updateTimer, 1000);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (tg.initDataUnsafe.user) {
                console.log("üë§ User ID:", tg.initDataUnsafe.user.id);
                console.log("üë§ Username:", tg.initDataUnsafe.user.username);
                document.getElementById('player-name').textContent = tg.initDataUnsafe.user.first_name || '–ò–≥—Ä–æ–∫';
            }
        }

        function showLoadingData() {
            console.log("üîÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...");
            
            userData = {
                gems: 5.0,
                food: 120,
                wood: 80,
                stone: 60,
                last_collection: Date.now() - 8 * 60 * 60 * 1000, // 8 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
                castle_level: 1,
                farm_level: 1,
                sawmill_level: 1,
                mine_level: 1,
                referrals_count: 2
            };
            
            updateResourcesDisplay();
            updateTimer();
        }

        function loadUserData() {
            try {
                console.log("üì® –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É –±–æ—Ç–∞...");
                
                const requestData = {
                    action: 'get_user_data',
                    user_id: tg.initDataUnsafe.user?.id,
                    timestamp: Date.now()
                };
                
                tg.sendData(JSON.stringify(requestData));
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.");
            }
        }

        function updateTimer() {
            if (!userData || !userData.last_collection) {
                document.getElementById('timerStatus').textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–π–º–µ—Ä–∞...";
                return;
            }
            
            const now = Date.now();
            const timePassed = now - userData.last_collection;
            const timeLeft = 12 * 60 * 60 * 1000 - timePassed;
            
            const timerElement = document.getElementById('timerStatus');
            const collectBtn = document.getElementById('collectBtn');
            
            if (timeLeft <= 0) {
                timerElement.innerHTML = "‚úÖ <strong>–†–µ—Å—É—Ä—Å—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–±–æ—Ä—É!</strong>";
                timerElement.className = "timer-status ready";
                collectBtn.disabled = false;
            } else {
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (60000)) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timerElement.innerHTML = `‚è≥ –î–æ —Å–±–æ—Ä–∞: <strong>${timeString}</strong>`;
                timerElement.className = "timer-status";
                collectBtn.disabled = true;
            }
        }

        function collectResources() {
            try {
                console.log("üéÅ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤...");
                
                const collectData = {
                    action: 'collect_resources',
                    user_id: tg.initDataUnsafe.user?.id,
                    timestamp: Date.now()
                };
                
                tg.sendData(JSON.stringify(collectData));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                tg.showPopup({
                    title: "‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
                    message: "–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É!",
                    buttons: [{ type: "ok" }]
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Ä–µ—Å—É—Ä—Å–æ–≤:", error);
                tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            }
        }

        function showReferralPopup() {
            const userId = tg.initDataUnsafe.user?.id;
            const referralLink = `https://t.me/CastleEmpireBot?start=ref_${userId}`;
            
            tg.showPopup({
                title: "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π",
                message: `–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!\n\nüîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:\n<code>${referralLink}</code>\n\n–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1% –æ—Ç –µ–≥–æ –¥–æ–±—ã—á–∏!`,
                buttons: [{
                    type: 'default',
                    text: 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',
                    id: 'copy'
                }, {
                    type: 'cancel',
                    text: '–ó–∞–∫—Ä—ã—Ç—å'
                }]
            }, function(buttonId) {
                if (buttonId === 'copy') {
                    navigator.clipboard.writeText(referralLink).then(() => {
                        tg.showAlert("‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
                    }).catch(() => {
                        tg.showAlert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É");
                    });
                }
            });
        }

        function showUpgradeMenu() {
            if (!userData) {
                tg.showAlert("–î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.");
                return;
            }
            
            document.getElementById('upgradeMenu').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            const upgradeOptions = document.getElementById('upgrade-options');
            upgradeOptions.innerHTML = `
                <div class="upgrade-option">
                    <div><strong>üè∞ –ó–∞–º–æ–∫</strong></div>
                    <div>–£—Ä–æ–≤–µ–Ω—å ${userData.castle_level || 1}</div>
                    <button onclick="upgradeBuilding('castle')" style="margin-top: 5px; padding: 8px 12px; background: #ff9d00; color: #093145; border: none; border-radius: 6px; font-weight: bold; width: 100%;">–£–ª—É—á—à–∏—Ç—å (100 üíé)</button>
                </div>
                <div class="upgrade-option">
                    <div><strong>üåæ –§–µ—Ä–º–∞</strong></div>
                    <div>–£—Ä–æ–≤–µ–Ω—å ${userData.farm_level || 1}</div>
                    <button onclick="upgradeBuilding('farm')" style="margin-top: 5px; padding: 8px 12px; background: #ff9d00; color: #093145; border: none; border-radius: 6px; font-weight: bold; width: 100%;">–£–ª—É—á—à–∏—Ç—å (80 üíé)</button>
                </div>
                <div class="upgrade-option">
                    <div><strong>ü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞</strong></div>
                    <div>–£—Ä–æ–≤–µ–Ω—å ${userData.sawmill_level || 1}</div>
                    <button onclick="upgradeBuilding('sawmill')" style="margin-top: 5px; padding: 8px 12px; background: #ff9d00; color: #093145; border: none; border-radius: 6px; font-weight: bold; width: 100%;">–£–ª—É—á—à–∏—Ç—å (90 üíé)</button>
                </div>
                <div class="upgrade-option">
                    <div><strong>‚õèÔ∏è –®–∞—Ö—Ç–∞</strong></div>
                    <div>–£—Ä–æ–≤–µ–Ω—å ${userData.mine_level || 1}</div>
                    <button onclick="upgradeBuilding('mine')" style="margin-top: 5px; padding: 8px 12px; background: #ff9d00; color: #093145; border: none; border-radius: 6px; font-weight: bold; width: 100%;">–£–ª—É—á—à–∏—Ç—å (70 üíé)</button>
                </div>
            `;
        }

        function upgradeBuilding(buildingType) {
            console.log("‚ö° –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ:", buildingType);
            
            const upgradeData = {
                action: 'upgrade_building',
                building: buildingType,
                user_id: tg.initDataUnsafe.user?.id,
                timestamp: Date.now()
            };
            
            tg.sendData(JSON.stringify(upgradeData));
            
            tg.showAlert(`üèóÔ∏è –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ ${buildingType} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
            hideMenus();
        }

        function hideMenus() {
            document.getElementById('upgradeMenu').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function showStats() {
            if (!userData) {
                tg.showAlert("–î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
                return;
            }
            
            const statsMessage = `
üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞</b>

üíé –ê–ª–º–∞–∑—ã: ${userData.gems.toFixed(1)}
üåæ –ï–¥–∞: ${userData.food}
ü™µ –î–µ—Ä–µ–≤–æ: ${userData.wood}
‚õ∞Ô∏è –ö–∞–º–µ–Ω—å: ${userData.stone}

üè∞ –ó–∞–º–æ–∫: –£—Ä. ${userData.castle_level}
üåæ –§–µ—Ä–º–∞: –£—Ä. ${userData.farm_level}
ü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞: –£—Ä. ${userData.sawmill_level}
‚õèÔ∏è –®–∞—Ö—Ç–∞: –£—Ä. ${userData.mine_level}

üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${userData.referrals_count}
            `;
            
         
