<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .resources {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .resource-item:last-child {
            border-bottom: none;
        }
        
        .resource-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .resource-info {
            flex-grow: 1;
        }
        
        .resource-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .resource-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .buildings {
            margin-bottom: 15px;
        }
        
        .building {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }
        
        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .building-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .building-level {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .buttons {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 25px;
            padding: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-collect {
            background: linear-gradient(45deg, #00b894, #00a085);
        }
        
        .btn-upgrade {
            background: linear-gradient(45deg, #fdcb6e, #f39c12);
        }
        
        .btn-sync {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        }
        
        .btn-invite {
            background: linear-gradient(45deg, #e84393, #fd79a8);
        }
        
        .btn-stats {
            background: linear-gradient(45deg, #00cec9, #81ecec);
        }
        
        .cooldown {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∞ Castle Empire</h1>
            <p>–†–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ–µ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ!</p>
        </div>
        
        <div class="resources">
            <div class="resource-item">
                <span class="resource-icon">üíé</span>
                <div class="resource-info">
                    <div class="resource-name">–ê–ª–º–∞–∑—ã</div>
                    <div class="resource-value" id="gems">5.0</div>
                </div>
            </div>
            
            <div class="resource-item">
                <span class="resource-icon">üåæ</span>
                <div class="resource-info">
                    <div class="resource-name">–ï–¥–∞</div>
                    <div class="resource-value" id="food">120</div>
                </div>
            </div>
            
            <div class="resource-item">
                <span class="resource-icon">ü™µ</span>
                <div class="resource-info">
                    <div class="resource-name">–î–µ—Ä–µ–≤–æ</div>
                    <div class="resource-value" id="wood">80</div>
                </div>
            </div>
            
            <div class="resource-item">
                <span class="resource-icon">‚õ∞Ô∏è</span>
                <div class="resource-info">
                    <div class="resource-name">–ö–∞–º–µ–Ω—å</div>
                    <div class="resource-value" id="stone">60</div>
                </div>
            </div>
        </div>
        
        <div class="cooldown" id="cooldown-info">
            ‚è≥ –°–ª–µ–¥—É—é—â–∏–π —Å–±–æ—Ä —á–µ—Ä–µ–∑: <span id="cooldown-time">12:00:00</span>
        </div>
        
        <div class="buttons">
            <button class="btn btn-collect" onclick="collectResources()">
                üîÑ –°–æ–±—Ä–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã
            </button>
            
            <button class="btn btn-sync" onclick="syncWithBot()">
                üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –±–æ—Ç–æ–º
            </button>
        </div>
        
        <div class="buildings">
            <div class="building">
                <div class="building-header">
                    <span class="building-name">üè∞ –ó–∞–º–æ–∫</span>
                    <span class="building-level" id="castle-level">–£—Ä. 1</span>
                </div>
                <button class="btn btn-upgrade" onclick="upgradeBuilding('castle', 5)">
                    –£–ª—É—á—à–∏—Ç—å (5üíé)
                </button>
            </div>
            
            <div class="building">
                <div class="building-header">
                    <span class="building-name">üåæ –§–µ—Ä–º–∞</span>
                    <span class="building-level" id="farm-level">–£—Ä. 1</span>
                </div>
                <button class="btn btn-upgrade" onclick="upgradeBuilding('farm', 3)">
                    –£–ª—É—á—à–∏—Ç—å (3üíé)
                </button>
            </div>
            
            <div class="building">
                <div class="building-header">
                    <span class="building-name">ü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞</span>
                    <span class="building-level" id="sawmill-level">–£—Ä. 1</span>
                </div>
                <button class="btn btn-upgrade" onclick="upgradeBuilding('sawmill', 3)">
                    –£–ª—É—á—à–∏—Ç—å (3üíé)
                </button>
            </div>
            
            <div class="building">
                <div class="building-header">
                    <span class="building-name">‚õ∞Ô∏è –®–∞—Ö—Ç–∞</span>
                    <span class="building-level" id="mine-level">–£—Ä. 1</span>
                </div>
                <button class="btn btn-upgrade" onclick="upgradeBuilding('mine', 3)">
                    –£–ª—É—á—à–∏—Ç—å (3üíé)
                </button>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-invite" onclick="showInvite()">
                üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π
            </button>
            
            <button class="btn btn-stats" onclick="showStats()">
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º...</p>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            gems: 5.0,
            food: 120,
            wood: 80,
            stone: 60,
            lastCollection: 0,
            buildings: {
                castle: 1,
                farm: 1,
                sawmill: 1,
                mine: 1
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram.WebApp;
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã
        function initGame() {
            console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...");
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ URL (–ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –±–æ—Ç–æ–º)
            const urlParams = new URLSearchParams(window.location.search);
            const initData = urlParams.get('data');
            
            if (initData) {
                try {
                    const parsedData = JSON.parse(decodeURIComponent(initData));
                    console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞:", parsedData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
                    if (parsedData.gems) gameState.gems = parsedData.gems;
                    if (parsedData.food) gameState.food = parsedData.food;
                    if (parsedData.wood) gameState.wood = parsedData.wood;
                    if (parsedData.stone) gameState.stone = parsedData.stone;
                    if (parsedData.lastCollection) gameState.lastCollection = parsedData.lastCollection;
                    if (parsedData.castle_level) gameState.buildings.castle = parsedData.castle_level;
                    if (parsedData.farm_level) gameState.buildings.farm = parsedData.farm_level;
                    if (parsedData.sawmill_level) gameState.buildings.sawmill = parsedData.sawmill_level;
                    if (parsedData.mine_level) gameState.buildings.mine = parsedData.mine_level;
                    
                    showNotification("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–æ—Ç–∞!", "success");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:", e);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage (–µ—Å–ª–∏ –µ—Å—Ç—å)
            loadFromStorage();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
            startCooldownTimer();
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(syncWithBot, 30000);
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        async function collectResources() {
            if (canCollect()) {
                showLoading(true);
                
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
                gameState.gems += 2.0;
                gameState.food += 50;
                gameState.wood += 30;
                gameState.stone += 20;
                gameState.lastCollection = Math.floor(Date.now() / 1000);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUI();
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º
                const success = await sendToBot('collect_resources');
                
                if (success) {
                    showNotification("‚úÖ –†–µ—Å—É—Ä—Å—ã —Å–æ–±—Ä–∞–Ω—ã! –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –±–æ—Ç–æ–º.", "success");
                } else {
                    showNotification("‚úÖ –†–µ—Å—É—Ä—Å—ã —Å–æ–±—Ä–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.", "warning");
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveToStorage();
                showLoading(false);
                
            } else {
                const timeLeft = getTimeLeft();
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                showNotification(`‚è≥ –°–ª–µ–¥—É—é—â–∏–π —Å–±–æ—Ä —á–µ—Ä–µ–∑ ${hours}—á ${minutes}–º`, "info");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏—è –∑–¥–∞–Ω–∏—è
        async function upgradeBuilding(buildingType, cost) {
            if (gameState.gems >= cost) {
                showLoading(true);
                
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                gameState.gems -= cost;
                gameState.buildings[buildingType]++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUI();
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º
                const success = await sendToBot('upgrade_building', {
                    building: buildingType,
                    cost: cost,
                    new_level: gameState.buildings[buildingType]
                });
                
                if (success) {
                    showNotification(`üèóÔ∏è ${getBuildingName(buildingType)} —É–ª—É—á—à–µ–Ω–æ –¥–æ —É—Ä–æ–≤–Ω—è ${gameState.buildings[buildingType]}!`, "success");
                } else {
                    showNotification(`üèóÔ∏è ${getBuildingName(buildingType)} —É–ª—É—á—à–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.`, "warning");
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                saveToStorage();
                showLoading(false);
                
            } else {
                showNotification("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è", "error");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º
        async function syncWithBot() {
            showLoading(true);
            showNotification("üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º...", "info");
            
            const success = await sendToBot('sync_data', {
                resources: {
                    gems: gameState.gems,
                    food: gameState.food,
                    wood: gameState.wood,
                    stone: gameState.stone,
                    lastCollection: gameState.lastCollection
                },
                buildings: gameState.buildings
            });
            
            if (success) {
                showNotification("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –±–æ—Ç–æ–º!", "success");
            } else {
                showNotification("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.", "warning");
            }
            
            showLoading(false);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function showInvite() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –¥–ª—è –ø–æ–∫–∞–∑–∞ invite –º–µ–Ω—é
            sendToBot('show_invite');
        }

        function showStats() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            sendToBot('show_stats');
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
        async function sendToBot(action, data = {}) {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    const message = JSON.stringify({
                        action: action,
                        timestamp: Date.now(),
                        ...data
                    });
                    
                    window.Telegram.WebApp.sendData(message);
                    console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É:", { action, ...data });
                    return true;
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                return false;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function canCollect() {
            const currentTime = Math.floor(Date.now() / 1000);
            return (currentTime - gameState.lastCollection) >= 43200; // 12 —á–∞—Å–æ–≤
        }

        function getTimeLeft() {
            const currentTime = Math.floor(Date.now() / 1000);
            const timePassed = currentTime - gameState.lastCollection;
            return Math.max(0, 43200 - timePassed);
        }

        function getBuildingName(buildingType) {
            const names = {
                'castle': '–ó–∞–º–æ–∫',
                'farm': '–§–µ—Ä–º–∞',
                'sawmill': '–õ–µ—Å–æ–ø–∏–ª–∫–∞',
                'mine': '–®–∞—Ö—Ç–∞'
            };
            return names[buildingType] || buildingType;
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function updateUI() {
            document.getElementById('gems').textContent = gameState.gems.toFixed(1);
            document.getElementById('food').textContent = gameState.food;
            document.getElementById('wood').textContent = gameState.wood;
            document.getElementById('stone').textContent = gameState.stone;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–Ω–∏ –∑–¥–∞–Ω–∏–π
            for (const [building, level] of Object.entries(gameState.buildings)) {
                const element = document.getElementById(`${building}-level`);
                if (element) {
                    element.textContent = `–£—Ä. ${level}`;
                }
            }
        }

        function startCooldownTimer() {
            setInterval(() => {
                const timeLeft = getTimeLeft();
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('cooldown-time').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('cooldown-info').style.display = timeLeft > 0 ? 'block' : 'none';
            }, 1000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å localStorage
        function saveToStorage() {
            localStorage.setItem('castle_empire_save', JSON.stringify(gameState));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('castle_empire_save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed };
                    console.log("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:", e);
                }
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'error' ? 'rgba(231, 76, 60, 0.9)' : 
                                          type === 'warning' ? 'rgba(241, 196, 15, 0.9)' : 
                                          type === 'success' ? 'rgba(46, 204, 113, 0.9)' : 
                                          'rgba(52, 152, 219, 0.9)';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'non
